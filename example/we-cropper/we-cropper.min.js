/**
 * we-cropper v1.2.0
 * (c) 2018 dlhandsome
 * @license MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.WeCropper=e()}(this,function(){"use strict";var o=void 0,e=["touchstarted","touchmoved","touchended"];function l(t){return"function"==typeof t}function a(o){for(var n=[],t=arguments.length-1;0<t--;)n[t]=arguments[t+1];e.forEach(function(t,e){void 0!==n[e]&&(o[t]=n[e])})}var i=function(){this._hooks={}};i.prototype.register=function(t,e){this._hooks[t]||(this._hooks[t]=[]),this._hooks[t].push(e)},i.prototype.hook=function(t){for(var e=this,o=[],n=arguments.length-1;0<n--;)o[n]=arguments[n+1];var r=[];return(this._hooks[t]||[]).forEach(function(t){"function"==typeof t&&r.push(t.apply(e,o))}),r},i.prototype.hookSequence=function(t,e){var o=this,n=e;return(this._hooks[t]||[]).forEach(function(t){"function"==typeof t&&(n=t.apply(o,n))}),n},i.prototype.hookReturnOrigin=function(t){for(var e=this,o=[],n=arguments.length-1;0<n--;)o[n]=arguments[n+1];return(this._hooks[t]||[]).forEach(function(t){"function"==typeof t&&t.apply(e,o)}),o};var n={},c={id:{default:"cropper",get:function(){return n.id},set:function(t){"string"!=typeof t&&console.error("id\uff1a"+t+" is invalid"),n.id=t}},width:{default:750,get:function(){return n.width},set:function(t){"number"!=typeof t&&console.error("width\uff1a"+t+" is invalid"),n.width=t}},height:{default:750,get:function(){return n.height},set:function(t){"number"!=typeof t&&console.error("height\uff1a"+t+" is invalid"),n.height=t}},scale:{default:2.5,get:function(){return n.scale},set:function(t){"number"!=typeof t&&console.error("scale\uff1a"+t+" is invalid"),n.scale=t}},zoom:{default:5,get:function(){return n.zoom},set:function(t){"number"!=typeof t?console.error("zoom\uff1a"+t+" is invalid"):(t<0||10<t)&&console.error("zoom should be ranged in 0 ~ 10"),n.zoom=t}},src:{default:"cropper",get:function(){return n.src},set:function(t){"string"!=typeof t&&console.error("id\uff1a"+t+" is invalid"),n.src=t}},cut:{default:{},get:function(){return n.cut},set:function(t){"object"!=typeof t&&console.error("id\uff1a"+t+" is invalid"),n.cut=t}},onReady:{default:null,get:function(){return n.ready},set:function(t){n.ready=t}},onBeforeImageLoad:{default:null,get:function(){return n.beforeImageLoad},set:function(t){n.beforeImageLoad=t}},onImageLoad:{default:null,get:function(){return n.imageLoad},set:function(t){n.imageLoad=t}},onBeforeDraw:{default:null,get:function(){return n.beforeDraw},set:function(t){n.beforeDraw=t}}};var f="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var t,r=(function(u,d){!function(t){var e=d,o=u&&u.exports==e&&u,n="object"==typeof f&&f;n.global!==n&&n.window!==n||(t=n);var r=function(t){this.message=t};(r.prototype=new Error).name="InvalidCharacterError";var h=function(t){throw new r(t)},s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c=/[\t\n\f\r ]/g,a={encode:function(t){t=String(t),/[^\0-\xFF]/.test(t)&&h("The string to be encoded contains characters outside of the Latin1 range.");for(var e,o,n,r,a=t.length%3,i="",c=-1,u=t.length-a;++c<u;)e=t.charCodeAt(c)<<16,o=t.charCodeAt(++c)<<8,n=t.charCodeAt(++c),i+=s.charAt((r=e+o+n)>>18&63)+s.charAt(r>>12&63)+s.charAt(r>>6&63)+s.charAt(63&r);return 2==a?(e=t.charCodeAt(c)<<8,o=t.charCodeAt(++c),i+=s.charAt((r=e+o)>>10)+s.charAt(r>>4&63)+s.charAt(r<<2&63)+"="):1==a&&(r=t.charCodeAt(c),i+=s.charAt(r>>2)+s.charAt(r<<4&63)+"=="),i},decode:function(t){var e=(t=String(t).replace(c,"")).length;e%4==0&&(e=(t=t.replace(/==?$/,"")).length),(e%4==1||/[^+a-zA-Z0-9/]/.test(t))&&h("Invalid character: the string to be decoded is not correctly encoded.");for(var o,n,r=0,a="",i=-1;++i<e;)n=s.indexOf(t.charAt(i)),o=r%4?64*o+n:n,r++%4&&(a+=String.fromCharCode(255&o>>(-2*r&6)));return a},version:"0.1.0"};if(e&&!e.nodeType)if(o)o.exports=a;else for(var i in a)a.hasOwnProperty(i)&&(e[i]=a[i]);else t.base64=a}(f)}(t={exports:{}},t.exports),t.exports);function x(t){var e="";if("string"==typeof t)e=t;else for(var o=0;o<t.length;o++)e+=String.fromCharCode(t[o]);return r.encode(e)}function u(t,e,o,n,r,a,i){var c,u,h,s,d,f;void 0===i&&(i=function(){}),void 0===a&&(a="png"),a="image/"+a.toLowerCase().replace(/jpg/i,"jpeg").match(/png|jpeg|bmp|gif/)[0],/bmp/.test(a)?(c=t,u=e,h=o,s=n,d=r,f=function(t){var e=function(t){var e=t.width,o=t.height,n=e*o*3,r=n+54,a=[66,77,255&r,r>>8&255,r>>16&255,r>>24&255,0,0,0,0,54,0,0,0],i=[40,0,0,0,255&e,e>>8&255,e>>16&255,e>>24&255,255&o,o>>8&255,o>>16&255,o>>24&255,1,0,24,0,0,0,0,0,255&n,n>>8&255,n>>16&255,n>>24&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],c=(4-3*e%4)%4,u=t.data,h="",s=e<<2,d=o,f=String.fromCharCode;do{for(var l=s*(d-1),g="",p=0;p<e;p++){var v=p<<2;g+=f(u[l+v+2])+f(u[l+v+1])+f(u[l+v])}for(var y=0;y<c;y++)g+=String.fromCharCode(0);h+=g}while(--d);return x(a.concat(i))+x(h)}(t);l(i)&&i("data:"+("image/"+a)+";base64,"+e)},wx.canvasGetImageData({canvasId:c,x:u,y:h,width:s,height:d,success:f,fail:function(t){f(null),console.error("canvasGetImageData error: "+t)}})):console.error("\u6682\u4e0d\u652f\u6301\u751f\u6210'"+a+"'\u7c7b\u578b\u7684base64\u56fe\u7247")}var g={convertToImage:u,convertToBMP:function(t,e){return void 0===t&&(t={}),void 0===e&&(e=function(){}),u(t.canvasId,t.x,t.y,t.width,t.height,"bmp",e)}};var h=function(t,e,o,n,r){var a,i;return a=Math.round(r.x-n.x),i=Math.round(r.y-n.y),t+.001*o*(Math.round(Math.sqrt(a*a+i*i))-e)};var s="touchstart",d="touchmove",p="touchend",v={touchStart:function(t){var e=this,o=t.touches,n=o[0],r=o[1];e._hook.hook(s,t,e),a(e,!0,null,null),e.__oneTouchStart(n),2<=t.touches.length&&e.__twoTouchStart(n,r)},touchMove:function(t){var e=this,o=t.touches,n=o[0],r=o[1];e._hook.hook(d,t,e),a(e,null,!0),1===t.touches.length&&e.__oneTouchMove(n),2<=t.touches.length&&e.__twoTouchMove(n,r)},touchEnd:function(t){this._hook.hook(p,t,this),a(this,!1,!1,!0),this.__xtouchEnd()}};var y=function(t){var e,o,n=this,r={};return e=n,o=c,Object.defineProperties(e,o),Object.keys(c).forEach(function(t){r[t]=c[t].default}),Object.assign(n,r,t),n._hook=new i,n.prepare(),n.attachPage(),n.createCtx(),n.observer(),n.cutt(),n.methods(),n.init(),n.update(),n};return y.prototype.init=function(){var t=this,e=t.src;return t.version="1.2.0","function"==typeof t.onReady&&t.onReady(t.ctx,t),e&&t.pushOrign(e),a(t,!1,!1,!1),t.oldScale=1,t.newScale=1,t},Object.assign(y.prototype,v),y.prototype.prepare=function(){var e=this,t=(o||(o=wx.getSystemInfoSync()),o).windowWidth;e.attachPage=function(){var t=getCurrentPages();t[t.length-1].wecropper=e},e.createCtx=function(){var t=e.id;t?e.ctx=wx.createCanvasContext(t):console.error("constructor: create canvas context failed, 'id' must be valuable")},e.deviceRadio=t/750},y.prototype.observer=function(){var o=this;o.on=function(t,e){return o._hook.register(t,e),o}},y.prototype.methods=function(){var a=this,i=a.id,c=a.deviceRadio,t=a.width,e=a.height,o=a.cut,u=o.x;void 0===u&&(u=0);var h=o.y;void 0===h&&(h=0);var s=o.width;void 0===s&&(s=t);var d=o.height;void 0===d&&(d=e),a.updateCanvas=function(){return a.croperTarget&&a.ctx.drawImage(a.croperTarget,a.imgLeft,a.imgTop,a.scaleWidth,a.scaleHeight),l(a.onBeforeDraw)&&a.onBeforeDraw(a.ctx,a),a.setBoundStyle(),a.ctx.draw(),a},a.pushOrign=function(t){return a.src=t,l(a.onBeforeImageLoad)&&a.onBeforeImageLoad(a.ctx,a),wx.getImageInfo({src:t,success:function(t){var e=t.width/t.height;a.croperTarget=t.path,e<s/d?(a.rectX=u,a.baseWidth=s,a.baseHeight=s/e,a.rectY=h-Math.abs((d-a.baseHeight)/2)):(a.rectY=h,a.baseWidth=d*e,a.baseHeight=d,a.rectX=u-Math.abs((s-a.baseWidth)/2)),a.imgLeft=a.rectX,a.imgTop=a.rectY,a.scaleWidth=a.baseWidth,a.scaleHeight=a.baseHeight,a.updateCanvas(),l(a.onImageLoad)&&a.onImageLoad(a.ctx,a)}}),a.update(),a},a.getCropperBase64=function(t){void 0===t&&(t=function(){}),g.convertToBMP({canvasId:i,x:u,y:h,width:s,height:d},t)},a.getCropperImage=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];var o=toString.call(t[0]),n=t[t.length-1];switch(o){case"[object Object]":var r=t[0].quality;void 0===r&&(r=10),"number"!=typeof r?console.error("quality\uff1a"+r+" is invalid"):(r<0||10<r)&&console.error("quality should be ranged in 0 ~ 10"),wx.canvasToTempFilePath({canvasId:i,x:u,y:h,width:s,height:d,destWidth:s*r/(10*c),destHeight:d*r/(10*c),success:function(t){l(n)&&n.call(a,t.tempFilePath)},fail:function(t){l(n)&&n.call(a,null)}});break;case"[object Function]":wx.canvasToTempFilePath({canvasId:i,x:u,y:h,width:s,height:d,destWidth:s/c,destHeight:d/c,success:function(t){l(n)&&n.call(a,t.tempFilePath)},fail:function(t){l(n)&&n.call(a,null)}})}return a}},y.prototype.cutt=function(){var a=this,i=a.width,c=a.height,t=a.cut,u=t.x;void 0===u&&(u=0);var h=t.y;void 0===h&&(h=0);var s=t.width;void 0===s&&(s=i);var d=t.height;void 0===d&&(d=c),a.outsideBound=function(t,e){a.imgLeft=u<=t?u:a.scaleWidth+t-u<=s?u+s-a.scaleWidth:t,a.imgTop=h<=e?h:a.scaleHeight+e-h<=d?h+d-a.scaleHeight:e},a.setBoundStyle=function(t){void 0===t&&(t={});var e=t.color;void 0===e&&(e="#04b00f");var o=t.mask;void 0===o&&(o="rgba(0, 0, 0, 0.3)");var n=t.lineWidth;void 0===n&&(n=1);var r=[{start:{x:u-n,y:h+10-n},step1:{x:u-n,y:h-n},step2:{x:u+10-n,y:h-n}},{start:{x:u-n,y:h+d-10+n},step1:{x:u-n,y:h+d+n},step2:{x:u+10-n,y:h+d+n}},{start:{x:u+s-10+n,y:h-n},step1:{x:u+s+n,y:h-n},step2:{x:u+s+n,y:h+10-n}},{start:{x:u+s+n,y:h+d-10+n},step1:{x:u+s+n,y:h+d+n},step2:{x:u+s-10+n,y:h+d+n}}];a.ctx.beginPath(),a.ctx.setFillStyle(o),a.ctx.fillRect(0,0,u,c),a.ctx.fillRect(u,0,s,h),a.ctx.fillRect(u,h+d,s,c-h-d),a.ctx.fillRect(u+s,0,i-u-s,c),a.ctx.fill(),r.forEach(function(t){a.ctx.beginPath(),a.ctx.setStrokeStyle(e),a.ctx.setLineWidth(n),a.ctx.moveTo(t.start.x,t.start.y),a.ctx.lineTo(t.step1.x,t.step1.y),a.ctx.lineTo(t.step2.x,t.step2.y),a.ctx.stroke()})}},y.prototype.update=function(){var u=this;u.src&&(u.__oneTouchStart=function(t){u.touchX0=Math.round(t.x),u.touchY0=Math.round(t.y)},u.__oneTouchMove=function(t){var e,o;if(u.touchended)return u.updateCanvas();e=Math.round(t.x-u.touchX0),o=Math.round(t.y-u.touchY0);var n=Math.round(u.rectX+e),r=Math.round(u.rectY+o);u.outsideBound(n,r),u.updateCanvas()},u.__twoTouchStart=function(t,e){var o,n,r;u.touchX1=Math.round(u.rectX+u.scaleWidth/2),u.touchY1=Math.round(u.rectY+u.scaleHeight/2),o=Math.round(e.x-t.x),n=Math.round(e.y-t.y),r=Math.round(Math.sqrt(o*o+n*n)),u.oldDistance=r},u.__twoTouchMove=function(t,e){var o=u.oldScale,n=u.oldDistance,r=u.scale,a=u.zoom;u.newScale=h(o,n,a,t,e),u.newScale<=1&&(u.newScale=1),u.newScale>=r&&(u.newScale=r),u.scaleWidth=Math.round(u.newScale*u.baseWidth),u.scaleHeight=Math.round(u.newScale*u.baseHeight);var i=Math.round(u.touchX1-u.scaleWidth/2),c=Math.round(u.touchY1-u.scaleHeight/2);u.outsideBound(i,c),u.updateCanvas()},u.__xtouchEnd=function(){u.oldScale=u.newScale,u.rectX=u.imgLeft,u.rectY=u.imgTop})},y});